name: Claude PR from Issue

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  claude:
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'claude') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: React to comment with eyes
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GRAYBOT_GITHUB_TOKEN }}
        run: gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=eyes

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Write prompt file
        shell: bash
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat <<EOF > .claude-prompt.txt
          You are working in a Magento 2 project. A GitHub issue has been filed.

          Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Instructions:
          1. Analyze the issue and understand what changes are needed.
          2. Make the necessary code changes to fix the issue.
          3. Write the following files:
             - .claude-commit-message.txt — a conventional commit message (e.g. fix: ..., feat: ...) referencing #${ISSUE_NUMBER}
             - .claude-pr-title.txt — a short PR title (under 70 chars)
             - .claude-pr-body.txt — a markdown PR body with exactly three sections:
               ## Debugging Steps — the exact steps you took to find the issue (only the steps that led to the answer, not dead ends)
               ## Root Cause — what was wrong and why
               ## Change Summary — what you changed to fix it
          You may use git for reading (status, diff, log) but do NOT run git commit, git push, or gh CLI.
          EOF

      - name: Run Claude in devcontainer
        timeout-minutes: 8
        uses: devcontainers/ci@v0.3
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        with:
          env: |
            CLAUDE_CODE_OAUTH_TOKEN
          push: never
          runCmd: |
            echo "=== Running prompt ===" && cat .claude-prompt.txt | claude --print --verbose

      - name: Commit, push, and create PR
        env:
          GH_TOKEN: ${{ secrets.GRAYBOT_GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          if git diff --quiet; then
            echo "No changes made by Claude"
            exit 0
          fi

          BRANCH="claude/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"
          git add -A
          git add -f .claude-commit-message.txt .claude-pr-title.txt .claude-pr-body.txt

          COMMIT_MSG=$(cat .claude-commit-message.txt 2>/dev/null || echo "fix: resolve issue #${ISSUE_NUMBER}")
          PR_TITLE=$(cat .claude-pr-title.txt 2>/dev/null || echo "Fix #${ISSUE_NUMBER}: ${{ github.event.issue.title }}")
          PR_BODY=$(cat .claude-pr-body.txt 2>/dev/null || echo "Automated fix for #${ISSUE_NUMBER}.")

          git reset -- .claude-commit-message.txt .claude-pr-title.txt .claude-pr-body.txt
          git -c user.name="gray-bot" -c user.email="gray-bot@users.noreply.github.com" \
            commit -m "$COMMIT_MSG"
          git push origin "$BRANCH"

          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --head "$BRANCH" \
            --base main